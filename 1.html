<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT/M3U 转换工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{box-sizing:border-box}
        body{margin:0;font:14px/1.5 "Microsoft YaHei";background:#f9fafb;color:#374151;display:flex;flex-direction:column;min-height:100vh}
        .top-nav,.footer-links{background:#4285f4;text-align:center;padding:10px 0;font-size:0}
        .top-nav a,.footer-links a{color:#fff;font-size:13px;margin:0 8px;padding:4px 6px;text-decoration:none}
        .top-nav a:hover,.footer-links a:hover{text-decoration:underline}
        .container{width:100%;max-width:1200px;margin:0 auto 24px;padding:16px;background:#fff;border-radius:0 0 8px 8px;box-shadow:0 0 6px rgba(0,0,0,.04);flex:1}
        h1{font-size:18px;text-align:center;margin:0 0 16px}
        .panels-container{display:flex;gap:20px;flex-wrap:wrap}
        .panel{flex:1;min-width:280px;background:#f8f9fa;border-radius:8px;padding:16px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
        .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e5e7eb}
        .panel-title{font-size:14px;color:#374151;font-weight:600}
        .format-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600;margin-left:8px}
        .badge-txt{background:#10b981;color:white}
        .badge-m3u{background:#8b5cf6;color:white}
        textarea{width:100%;min-height:280px;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-family:monospace;font-size:14px;resize:vertical;line-height:1.5}
        textarea:focus{outline:none;border-color:#4285f4;box-shadow:0 0 0 2px rgba(66,133,244,.2)}
        .upload-area{border:2px dashed #d1d5db;border-radius:6px;padding:20px;text-align:center;margin-bottom:16px;transition:all .3s;background:#f9fafb}
        .upload-area:hover,.upload-area.dragover{border-color:#4285f4;background:#f0f7ff}
        .upload-icon{font-size:32px;color:#9ca3af;margin-bottom:8px}
        .upload-text{margin-bottom:12px;font-size:14px;color:#6b7280}
        .btn{padding:8px 16px;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s;display:inline-flex;align-items:center;justify-content:center;margin:4px}
        .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .btn i{margin-right:6px}
        .btn-primary{background:#4285f4}
        .btn-primary:hover{background:#3367d6}
        .btn-success{background:#10b981}
        .btn-success:hover{background:#059669}
        .btn-danger{background:#ef476f}
        .btn-danger:hover{background:#d90429}
        .convert-container{display:flex;justify-content:center;align-items:center;margin:16px 0}
        .button-group{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
        .file-input{display:none}
        .copyright{background:#f8fafc;font-size:12px;color:#64748b;text-align:center;padding:10px 0;border-top:1px solid #f0f0f0}
        @media(max-width:768px){.panels-container{flex-direction:column}.panel{min-width:100%}}
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <div class="top-nav">
        <a href="./index.html">我的主页</a>
        <a href="./1.html">格式转换</a>
        <a href="./2.html">加密工具</a>
        <a href="./pl/html">批量工具</a>
    </div>

    <div class="container">
        <h1>TXT/M3U 转换工具</h1>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <p class="upload-text">拖放文件到此处，或点击上传</p>
            <button class="btn btn-primary" id="uploadButton">
                <i class="fas fa-folder-open"></i> 选择文件
            </button>
            <input type="file" id="fileInput" class="file-input" accept=".txt,.m3u">
        </div>

        <div class="panels-container">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">输入内容 <span class="format-badge" id="inputFormatBadge"></span></h3>
                </div>
                <textarea id="inputEditor" placeholder="输入内容将显示在这里..."></textarea>
            </div>

            <div class="convert-container">
                <button class="btn btn-success" id="convertBtn" disabled>
                    <i class="fas fa-exchange-alt"></i> 转换格式
                </button>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">输出内容 <span class="format-badge" id="outputFormatBadge"></span></h3>
                </div>
                <textarea id="outputEditor" placeholder="输出内容将显示在这里..." readonly></textarea>

                <div class="button-group">
                    <button class="btn btn-primary" id="copyOutputBtn" disabled>
                        <i class="fas fa-copy"></i> 复制结果
                    </button>
                    <button class="btn btn-success" id="downloadBtn" disabled>
                        <i class="fas fa-download"></i> 下载输出
                    </button>
                    <button class="btn btn-danger" id="clearAllBtn">
                        <i class="fas fa-trash"></i> 清除全部
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部链接 -->
    <div class="footer-links">
        <a onclick="window.open('https://link3.cc/gyjune')">我的工具箱</a>
        <a onclick="alert('邮箱：gyjune@126.com')">我的邮箱</a>
        <a onclick="window.open('https://weibo.com/u/1771411553')">我的微博</a>
        <a href="./1.html">格式转换</a>
        <a href="./2.html">加密工具</a>
        <a href="./3.html">格式转换工具</a>
    </div>
    <div class="copyright">Copyright © 2025 多功能网站 | 版权所有</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const inputEditor = document.getElementById('inputEditor');
            const outputEditor = document.getElementById('outputEditor');
            const convertBtn = document.getElementById('convertBtn');
            const copyOutputBtn = document.getElementById('copyOutputBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const inputFormatBadge = document.getElementById('inputFormatBadge');
            const outputFormatBadge = document.getElementById('outputFormatBadge');

            let inputFormat = null;
            let outputFormat = null;

            uploadButton.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', handleFileSelect);

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            inputEditor.addEventListener('input', () => {
                detectInputFormat();
                updateConvertButtonState();
            });

            function handleFileSelect(e) {
                if (fileInput.files.length) {
                    handleFile(fileInput.files[0]);
                }
            }

            function handleFile(file) {
                const fileName = file.name.toLowerCase();
                if (!fileName.endsWith('.txt') && !fileName.endsWith('.m3u')) {
                    alert('请上传TXT或M3U格式的文件');
                    return;
                }

                const reader = new FileReader();

                reader.onload = (e) => {
                    const content = e.target.result;
                    inputEditor.value = content;
                    detectInputFormat();
                    updateConvertButtonState();
                };

                reader.onerror = () => {
                    alert('读取文件时出错，请重试');
                };

                reader.readAsText(file);
            }

            function detectInputFormat() {
                const content = inputEditor.value.trim();

                if (content.includes('#EXTM3U')) {
                    inputFormat = 'm3u';
                    inputFormatBadge.textContent = 'M3U';
                    inputFormatBadge.className = 'format-badge badge-m3u';
                    outputFormat = 'txt';
                    outputFormatBadge.textContent = 'TXT';
                    outputFormatBadge.className = 'format-badge badge-txt';
                } else if (content) {
                    inputFormat = 'txt';
                    inputFormatBadge.textContent = 'TXT';
                    inputFormatBadge.className = 'format-badge badge-txt';
                    outputFormat = 'm3u';
                    outputFormatBadge.textContent = 'M3U';
                    outputFormatBadge.className = 'format-badge badge-m3u';
                } else {
                    inputFormat = null;
                    inputFormatBadge.textContent = '';
                    inputFormatBadge.className = 'format-badge';
                    outputFormat = null;
                    outputFormatBadge.textContent = '';
                    outputFormatBadge.className = 'format-badge';
                }
            }

            function updateConvertButtonState() {
                convertBtn.disabled = !inputEditor.value.trim();
            }

            convertBtn.addEventListener('click', () => {
                const content = inputEditor.value.trim();

                if (!content) {
                    alert('请输入要转换的内容');
                    return;
                }

                if (inputFormat === 'txt') {
                    outputEditor.value = convertTxtToM3u(content);
                    outputFormat = 'm3u';
                    outputFormatBadge.textContent = 'M3U';
                    outputFormatBadge.className = 'format-badge badge-m3u';
                } else {
                    outputEditor.value = convertM3uToTxt(content);
                    outputFormat = 'txt';
                    outputFormatBadge.textContent = 'TXT';
                    outputFormatBadge.className = 'format-badge badge-txt';
                }

                copyOutputBtn.disabled = false;
                downloadBtn.disabled = false;
            });

            copyOutputBtn.addEventListener('click', () => {
                outputEditor.select();
                document.execCommand('copy');

                const originalText = copyOutputBtn.innerHTML;
                copyOutputBtn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                setTimeout(() => {
                    copyOutputBtn.innerHTML = originalText;
                }, 1500);
            });

            clearAllBtn.addEventListener('click', () => {
                inputEditor.value = '';
                outputEditor.value = '';
                inputFormatBadge.textContent = '';
                inputFormatBadge.className = 'format-badge';
                outputFormatBadge.textContent = '';
                outputFormatBadge.className = 'format-badge';
                inputFormat = null;
                outputFormat = null;
                convertBtn.disabled = true;
                copyOutputBtn.disabled = true;
                downloadBtn.disabled = true;
                fileInput.value = '';
            });

            downloadBtn.addEventListener('click', () => {
                const content = outputEditor.value;
                if (!content) {
                    alert('没有内容可下载');
                    return;
                }

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                const extension = outputFormat === 'txt' ? '.txt' : '.m3u';
                a.href = url;
                a.download = `live${extension}`;
                a.click();

                URL.revokeObjectURL(url);
            });

            function convertTxtToM3u(txtContent) {
                const lines = txtContent.split('\n');
                let m3uContent = '#EXTM3U x-tvg-url="https://gitee.com/taksssss/tv/raw/main/epg/51zmt.xml.gz"\n';
                let currentGroup = '';

                for (const line of lines) {
                    const trimmedLine = line.trim();

                    if (!trimmedLine) continue;

                    if (trimmedLine.endsWith(',#genre#')) {
                        currentGroup = trimmedLine.replace(',#genre#', '');
                        continue;
                    }

                    if (trimmedLine.includes(',')) {
                        const [name, url] = trimmedLine.split(',');
                        if (name && url) {
                            const channelId = name.trim().replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');
                            m3uContent += `#EXTINF:-1,tvg-id="${channelId}" tvg-name="${name.trim()}" tvg-logo="https://gitee.com/gyjune/logo/raw/master/${channelId}.png" group-title="${currentGroup}",${name.trim()}\n`;
                            m3uContent += `${url.trim()}\n`;
                        }
                    }
                }

                return m3uContent;
            }

            function convertM3uToTxt(m3uContent) {
                const lines = m3uContent.split('\n');
                let txtContent = '';
                let currentGroup = '';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (!line) continue;

                    if (line.startsWith('#EXTM3U')) {
                        continue;
                    }

                    if (line.startsWith('#EXTINF:')) {
                        const groupMatch = line.match(/group-title="([^"]*)"/);
                        if (groupMatch && groupMatch[1]) {
                            if (groupMatch[1] !== currentGroup) {
                                currentGroup = groupMatch[1];
                                txtContent += `${currentGroup},#genre#\n`;
                            }
                        }

                        const nameMatch = line.match(/,(.*)$/);
                        if (nameMatch && nameMatch[1]) {
                            const channelName = nameMatch[1].trim();

                            if (i + 1 < lines.length) {
                                const urlLine = lines[i + 1].trim();
                                if (urlLine && !urlLine.startsWith('#')) {
                                    txtContent += `${channelName},${urlLine}\n`;
                                    i++;
                                }
                            }
                        }
                    }
                }

                return txtContent;
            }
        });
    </script>
</body>
</html>
